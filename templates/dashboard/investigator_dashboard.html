<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Investigator Dashboard</title>
  <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    .kpi { display:grid; grid-template-columns:repeat(3,1fr); gap:16px; margin:16px 0; }
    .kpi .summary-card{display:flex;align-items:center;gap:12px}
    .toolbar .btn{margin-left:6px}
    .container{max-width:1800px}

    /* Filters bar polish */
    .filters-bar{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    .filters-bar .filters-group{display:flex;align-items:center;gap:8px;background:#f9fafb;border:1px solid var(--border);padding:8px 10px;border-radius:10px}
    .filters-bar .group-label{font-size:12px;color:var(--muted);font-weight:600;letter-spacing:.02em;text-transform:uppercase}
    .filters-bar input[type="date"]{padding:10px 12px;border:1px solid var(--border);border-radius:8px;background:var(--card);color:var(--text);min-width:160px;box-shadow:inset 0 1px 2px rgba(0,0,0,.04);transition:border-color .2s,box-shadow .2s}
    .filters-bar input[type="date"]:focus{outline:none;border-color:var(--brand);box-shadow:0 0 0 3px rgba(76,175,80,.2)}
    .filters-bar .btn{height:38px}
    .filters-bar .btn.sm{height:auto;padding:6px 10px}
    .filters-bar .btn.ghost{background:var(--card);border-color:var(--border);color:#374151}
    .filters-bar .btn.ghost:hover{border-color:#d1d5db;box-shadow:0 1px 2px rgba(0,0,0,.05)}
    .filters-bar .chips,.filters-bar .chips-scroll{display:flex;gap:8px;flex-wrap:wrap}
    .filters-bar .chips-scroll{overflow-x:auto;padding-bottom:4px}
    .filters-bar .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--border);background:var(--card);border-radius:999px;font-size:13px}
    .filters-bar .pill input{accent-color:var(--brand)}
    .filters-bar .type-grid{display:flex;flex-wrap:wrap;gap:8px}
    /* Smaller chips just for Type filters */
    #typeChips{gap:6px}
    #typeChips .pill{padding:2px 8px;font-size:12px;line-height:1.2;border-radius:12px;flex:0 0 auto;width:auto;white-space:nowrap}
    .filters-bar.compact{gap:8px}
    .filters-bar.compact .filters-group{padding:6px 8px;gap:6px}
    .filters-bar.compact input[type="date"]{min-width:140px;padding:8px 10px}

    /* Date inputs with icon */
    .input-with-icon{position:relative;display:inline-flex;align-items:center}
    .input-with-icon svg{position:absolute;left:10px;top:50%;transform:translateY(-50%);width:16px;height:16px;color:#6b7280;pointer-events:none}
    /* Ensure icon doesn't overlap the date text (override earlier padding) */
    .filters-bar .input-with-icon input[type="date"]{padding-left:36px}

    /* Simple layout for charts if not already styled */
    .charts-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(560px,1fr));gap:24px}
    .chart-box{background:#fff;border:1px solid var(--border);border-radius:12px;padding:18px;min-height:560px;display:flex;flex-direction:column}
    .chart-box header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;color:var(--muted);font-weight:600;font-size:14px}
    .chart-canvas{width:100%;height:520px}
    @media (min-width:1680px){
      .charts-grid{grid-template-columns:repeat(2,minmax(720px,1fr))}
      .chart-box{min-height:620px}
      .chart-canvas{height:580px}
    }
  </style>
</head>
<body>
  {% include 'partials/header.html' %}
  
  <div class="container">
    {% include 'partials/flashes.html' %}
    <div class="kpi">
      <div class="summary-card">
        <div class="pill pill-new">N</div>
        <div>
          <h2 id="kpiNew">{{ new_reports }}</h2>
          <p class="muted">New Reports</p>
        </div>
      </div>
      <div class="summary-card">
        <div class="pill pill-ongoing">O</div>
        <div>
          <h2 id="kpiOngoing">{{ ongoing_investigations }}</h2>
          <p class="muted">Ongoing Investigations</p>
        </div>
      </div>
      <div class="summary-card">
        <div class="pill pill-resolved">R</div>
        <div>
          <h2 id="kpiResolved">{{ resolved_cases }}</h2>
          <p class="muted">Resolved Cases</p>
        </div>
      </div>
    </div>

    <!-- Horizontal filters bar -->
    <div class="card filters-bar" id="filtersPanel">
      <div class="filters-group">
        <span class="group-label">From</span>
        <span class="input-with-icon">
          <svg aria-hidden="true" viewBox="0 0 24 24" fill="currentColor"><path d="M7 2a1 1 0 011 1v1h8V3a1 1 0 112 0v1h1a2 2 0 012 2v12a2 2 0 01-2 2H4a2 2 0 01-2-2V6a2 2 0 012-2h1V3a1 1 0 112 0v1zm13 8H4v8a1 1 0 001 1h14a1 1 0 001-1v-8zM4 8h16V6H4v2z"></path></svg>
          <input type="date" id="dateFrom" aria-label="From date" />
        </span>
        <span class="group-label">To</span>
        <span class="input-with-icon">
          <svg aria-hidden="true" viewBox="0 0 24 24" fill="currentColor"><path d="M7 2a1 1 0 011 1v1h8V3a1 1 0 112 0v1h1a2 2 0 012 2v12a2 2 0 01-2 2H4a2 2 0 01-2-2V6a2 2 0 012-2h1V3a1 1 0 112 0v1zm13 8H4v8a1 1 0 001 1h14a1 1 0 001-1v-8zM4 8h16V6H4v2z"></path></svg>
          <input type="date" id="dateTo" aria-label="To date" />
        </span>
        <button class="btn primary" id="applyFiltersBtn">Apply</button>
        <button class="btn ghost" id="resetFiltersBtn">Reset</button>
        <button class="btn ghost" id="saveDefaultsBtn">Save Default</button>
        <button class="btn ghost" id="toggleCompact">Compact</button>
      </div>
      <div class="filters-group">
        <span class="group-label">Quick</span>
        <button class="btn sm ghost rangeBtn" data-range="30d">30d</button>
        <button class="btn sm ghost rangeBtn" data-range="90d">90d</button>
        <button class="btn sm ghost rangeBtn" data-range="ytd">YTD</button>
        <button class="btn sm ghost rangeBtn" data-range="12m">12m</button>
        <button class="btn sm ghost rangeBtn" data-range="all">All</button>
      </div>
      <div class="filters-group">
        <span class="group-label">Statuses</span>
        <div class="chips-scroll">
          <label class="pill"><input type="checkbox" class="statusChk" value="New" checked /> New</label>
          <label class="pill"><input type="checkbox" class="statusChk" value="Ongoing" checked /> Ongoing</label>
          <label class="pill"><input type="checkbox" class="statusChk" value="Resolved" checked /> Resolved</label>
        </div>
      </div>
      <div class="filters-group" style="flex:1 1 100%">
        <span class="group-label">Types</span>
        <div class="chips" style="margin-right:8px">
          <button class="btn sm ghost" id="typesAll">Select All</button>
          <button class="btn sm ghost" id="typesNone">Clear</button>
          <button class="btn sm ghost" id="typesInvert">Invert</button>
        </div>
        <div id="typeChips" class="type-grid" style="flex:1 1 auto">
          {% for t in unique_types %}
          <label class="pill"><input type="checkbox" class="typeChk" value="{{ t }}" checked /> {{ t.replace('_',' ') }}</label>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Charts in 4-column grid -->
    <div class="card">
      <h3>Insights</h3>
      <div class="charts-grid">
        <div id="statusWrap" class="chart-box">
          <header><span>Status Mix</span><a class="btn sm" id="dlStatus">Export PNG</a></header>
          <canvas id="statusChart" class="chart-canvas"></canvas>
        </div>
        <div id="typeWrap" class="chart-box">
          <header><span>Type Mix</span><a class="btn sm" id="dlType">Export PNG</a></header>
          <canvas id="typeChart" class="chart-canvas"></canvas>
        </div>
        <div id="trendWrap" class="chart-box">
          <header><span>Monthly Trend</span><a class="btn sm" id="dlTrend">Export PNG</a></header>
          <canvas id="trendChart" class="chart-canvas"></canvas>
        </div>
        <div id="agingWrap" class="chart-box">
          <header><span>Aging Buckets</span><a class="btn sm" id="dlAging">Export PNG</a></header>
          <canvas id="agingChart" class="chart-canvas"></canvas>
        </div>
        <div id="topTypeWrap" class="chart-box">
          <header><span>Top Types</span><a class="btn sm" id="dlTopType">Export PNG</a></header>
          <canvas id="topTypeChart" class="chart-canvas"></canvas>
        </div>
      </div>
    </div>

    <script>
      function ensureChartJs(cb){
        if(window.Chart){ cb(); return; }
        const s=document.createElement('script');
        s.src='https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js';
        s.onload=cb; s.onerror=()=>cb();
        document.head.appendChild(s);
      }

      function initDashboard(){
        const REPORTS = {{ reports_data | tojson }};
        const el = q=>document.querySelector(q);
        const els = q=>Array.from(document.querySelectorAll(q));

        const dateFrom = el('#dateFrom');
        const dateTo   = el('#dateTo');
        const applyBtn = el('#applyFiltersBtn');
        const resetBtn = el('#resetFiltersBtn');
        const saveBtn  = el('#saveDefaultsBtn');
        const compactBtn = el('#toggleCompact');
        const filtersPanel = el('#filtersPanel');
        const typeAllBtn = el('#typesAll');
        const typeNoneBtn = el('#typesNone');
        const typeInvertBtn = el('#typesInvert');

        const kpiNew = el('#kpiNew');
        const kpiOngoing = el('#kpiOngoing');
        const kpiResolved = el('#kpiResolved');

        const parseTS = s => new Date((s||'').replace(' ','T'));
        function withinRange(r, from, to){
          const d = parseTS(r.timestamp); if(isNaN(d)) return false;
          return (!from || d>=from) && (!to || d<=to);
        }
        function filteredData(){
          const from = dateFrom.value ? new Date(dateFrom.value+'T00:00:00') : null;
          const to   = dateTo.value   ? new Date(dateTo.value  +'T23:59:59') : null;
          const statuses = new Set(els('.statusChk:checked').map(x=>x.value));
          const types    = new Set(els('.typeChk:checked').map(x=>x.value));
          return REPORTS.filter(r=> statuses.has(r.status||'') && (!types.size || types.has(r.report_type||'')) && withinRange(r, from, to));
        }
        function updateKPIs(rows){
          let n=0,o=0,rs=0; rows.forEach(r=>{const s=r.status||''; if(s==='New') n++; else if(s==='Ongoing') o++; else if(s==='Resolved') rs++;});
          kpiNew.textContent=n; kpiOngoing.textContent=o; kpiResolved.textContent=rs;
        }

        const hasChart = !!window.Chart;
        const statusChart = hasChart? new Chart(el('#statusChart'),{type:'doughnut',data:{labels:[],datasets:[{data:[],backgroundColor:['#3b82f6','#f59e0b','#10b981'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom'}}}}):null;
        const typeChart   = hasChart? new Chart(el('#typeChart'),{type:'bar',data:{labels:[],datasets:[{label:'Reports',data:[],backgroundColor:'#94a3b8'}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true,ticks:{precision:0}}},plugins:{legend:{display:false}}}}):null;
        const trendChart  = hasChart? new Chart(el('#trendChart'),{type:'line',data:{labels:[],datasets:[{label:'Reports per Month',data:[],borderColor:'#10b981',backgroundColor:'rgba(16,185,129,.15)',fill:true,tension:.3}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true,ticks:{precision:0}}},plugins:{legend:{display:false}}}}):null;
        const agingChart  = hasChart? new Chart(el('#agingChart'),{type:'bar',data:{labels:['0-7','8-30','31-90','90+'],datasets:[{label:'Count',data:[0,0,0,0],backgroundColor:'#60a5fa'}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true,ticks:{precision:0}}},plugins:{legend:{display:false}}}}):null;
        const topTypeChart= hasChart? new Chart(el('#topTypeChart'),{type:'bar',data:{labels:[],datasets:[{label:'Top Types',data:[],backgroundColor:'#a78bfa'}]},options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',scales:{x:{beginAtZero:true,ticks:{precision:0}}},plugins:{legend:{display:false}}}}):null;

        function clearCanvas(id){ const c=el('#'+id); if(!c) return; const ctx=c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height); }
        function drawDoughnut(id, labels, data, colors){ const c=el('#'+id); if(!c) return; const ctx=c.getContext('2d'); const W=c.width=c.clientWidth,H=c.height=c.clientHeight; const cx=W/2,cy=H/2,r=Math.min(W,H)/2-10; const total=data.reduce((a,b)=>a+b,0)||1; let start=-Math.PI/2; data.forEach((v,i)=>{ const ang=2*Math.PI*v/total; ctx.beginPath(); ctx.moveTo(cx,cy); ctx.fillStyle=colors[i%colors.length]||'#888'; ctx.arc(cx,cy,r,start,start+ang); ctx.fill(); start+=ang; }); ctx.beginPath(); ctx.fillStyle='#fff'; ctx.arc(cx,cy,r*0.6,0,2*Math.PI); ctx.fill(); }
        function drawBar(id, labels, data, opts={horizontal:false,color:'#94a3b8'}){ const c=el('#'+id); if(!c) return; const ctx=c.getContext('2d'); const W=c.width=c.clientWidth,H=c.height=c.clientHeight; ctx.clearRect(0,0,W,H); const max=Math.max(1,...data),pad=30; if(opts.horizontal){ const barH=(H-pad*2)/data.length*0.7; data.forEach((v,i)=>{ const y=pad+i*((H-pad*2)/data.length); const w=(W-pad*2)*(v/max); ctx.fillStyle=opts.color; ctx.fillRect(pad,y,Math.max(2,w),barH); }); } else { const barW=(W-pad*2)/data.length*0.7; data.forEach((v,i)=>{ const x=pad+i*((W-pad*2)/data.length); const h=(H-pad*2)*(v/max); ctx.fillStyle=opts.color; ctx.fillRect(x,H-pad-h,barW,h); }); } }
        function drawLine(id, labels, data){ const c=el('#'+id); if(!c) return; const ctx=c.getContext('2d'); const W=c.width=c.clientWidth,H=c.height=c.clientHeight; ctx.clearRect(0,0,W,H); const pad=30,max=Math.max(1,...data),stepX=(W-pad*2)/Math.max(1,data.length-1); ctx.strokeStyle='#10b981'; ctx.lineWidth=2; ctx.beginPath(); data.forEach((v,i)=>{ const x=pad+i*stepX; const y=H-pad-(H-pad*2)*(v/max); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); }); ctx.stroke(); ctx.fillStyle='rgba(16,185,129,.15)'; ctx.lineTo(W-pad,H-pad); ctx.lineTo(pad,H-pad); ctx.closePath(); ctx.fill(); }

        function recomputeAndRender(){
          const rws = filteredData();
          updateKPIs(rws);

          const sCounts = rws.reduce((acc,r)=>{const s=r.status||'Unknown'; acc[s]=(acc[s]||0)+1; return acc;},{});
          const sLabels = Object.keys(sCounts), sValues = Object.values(sCounts);
          if(hasChart){ statusChart.data.labels=sLabels; statusChart.data.datasets[0].data=sValues; statusChart.update(); } else { clearCanvas('statusChart'); drawDoughnut('statusChart',sLabels,sValues,['#3b82f6','#f59e0b','#10b981']); }

          const tCounts = rws.reduce((acc,r)=>{const t=r.report_type||'Other'; acc[t]=(acc[t]||0)+1; return acc;},{});
          const typeLabels = Object.keys(tCounts).map(t=>t.replaceAll('_',' '));
          const typeValues = Object.values(tCounts);
          if(hasChart){ typeChart.data.labels=typeLabels; typeChart.data.datasets[0].data=typeValues; typeChart.update(); } else { clearCanvas('typeChart'); drawBar('typeChart',typeLabels,typeValues,{horizontal:false,color:'#94a3b8'}); }

          const m = {}; rws.forEach(r=>{ const key=(r.timestamp||'').slice(0,7); if(key) m[key]=(m[key]||0)+1; });
          const mLabels = Object.keys(m).sort(); const trendValues = mLabels.map(k=>m[k]);
          if(hasChart){ trendChart.data.labels=mLabels; trendChart.data.datasets[0].data=trendValues; trendChart.update(); } else { clearCanvas('trendChart'); drawLine('trendChart',mLabels,trendValues); }

          const now=new Date(); const buckets=[0,0,0,0];
          rws.forEach(r=>{ const d=parseTS(r.timestamp); if(isNaN(d)) return; const days=Math.floor((now-d)/(1000*60*60*24)); if(days<=7) buckets[0]++; else if(days<=30) buckets[1]++; else if(days<=90) buckets[2]++; else buckets[3]++; });
          if(hasChart){ agingChart.data.datasets[0].data=buckets; agingChart.update(); } else { clearCanvas('agingChart'); drawBar('agingChart',['0-7','8-30','31-90','90+'],buckets,{horizontal:false,color:'#60a5fa'}); }

          const topPairs = Object.entries(tCounts).sort((a,b)=>b[1]-a[1]).slice(0,5);
          const topLabels = topPairs.map(p=>p[0].replaceAll('_',' ')); const topValues = topPairs.map(p=>p[1]);
          if(hasChart){ topTypeChart.data.labels=topLabels; topTypeChart.data.datasets[0].data=topValues; topTypeChart.update(); } else { clearCanvas('topTypeChart'); drawBar('topTypeChart',topLabels,topValues,{horizontal:true,color:'#a78bfa'}); }
        }

        function setDefaults(){
          const today=new Date(); const from=new Date(); from.setDate(today.getDate()-90);
          dateTo.value=today.toISOString().slice(0,10); dateFrom.value=from.toISOString().slice(0,10);
          els('.statusChk').forEach(c=>c.checked=true); els('.typeChk').forEach(c=>c.checked=true);
        }
        function setQuickRange(key){
          const today=new Date(); let from=null,to=today;
          if(key==='30d'){ from=new Date(); from.setDate(today.getDate()-29); }
          else if(key==='90d'){ from=new Date(); from.setDate(today.getDate()-89); }
          else if(key==='ytd'){ from=new Date(today.getFullYear(),0,1); }
          else if(key==='12m'){ from=new Date(); from.setDate(today.getDate()-364); }
          else if(key==='all'){ dateFrom.value=''; dateTo.value=''; return; }
          dateFrom.value=from.toISOString().slice(0,10); dateTo.value=to.toISOString().slice(0,10);
        }
        function saveDefaults(){
          const payload={ from:dateFrom.value, to:dateTo.value, statuses:els('.statusChk').map(x=>({v:x.value,c:x.checked})), types:els('.typeChk').map(x=>({v:x.value,c:x.checked})) };
          localStorage.setItem('dashboard_prefs', JSON.stringify(payload));
        }
        function loadDefaults(){
          const raw=localStorage.getItem('dashboard_prefs'); if(!raw){ setDefaults(); return; }
          try{
            const p=JSON.parse(raw);
            if(p.from) dateFrom.value=p.from; if(p.to) dateTo.value=p.to;
            if(Array.isArray(p.statuses)){ const map=new Map(p.statuses.map(x=>[x.v,x.c])); els('.statusChk').forEach(c=> c.checked=map.get(c.value) ?? true); }
            if(Array.isArray(p.types)){ const map=new Map(p.types.map(x=>[x.v,x.c])); els('.typeChk').forEach(c=> c.checked=map.get(c.value) ?? true); }
          }catch(e){ setDefaults(); }
        }

        // Listeners
        applyBtn.addEventListener('click',e=>{e.preventDefault(); recomputeAndRender();});
        resetBtn.addEventListener('click',e=>{e.preventDefault(); setDefaults(); recomputeAndRender();});
        saveBtn.addEventListener('click',e=>{e.preventDefault(); saveDefaults();});
        els('.statusChk').forEach(c=>c.addEventListener('change',recomputeAndRender));
        els('.typeChk').forEach(c=>c.addEventListener('change',recomputeAndRender));
        els('.rangeBtn').forEach(b=>b.addEventListener('click',e=>{e.preventDefault(); setQuickRange(b.dataset.range); recomputeAndRender(); }));
        typeAllBtn.addEventListener('click',e=>{e.preventDefault(); els('.typeChk').forEach(c=>c.checked=true); recomputeAndRender();});
        typeNoneBtn.addEventListener('click',e=>{e.preventDefault(); els('.typeChk').forEach(c=>c.checked=false); recomputeAndRender();});
        typeInvertBtn.addEventListener('click',e=>{e.preventDefault(); els('.typeChk').forEach(c=>c.checked=!c.checked); recomputeAndRender();});
        compactBtn.addEventListener('click',e=>{e.preventDefault(); filtersPanel.classList.toggle('compact');});

        // Export helpers
        function exportCanvas(aSel, canvasId, name){
          const a=el(aSel); a.addEventListener('click',()=>{ const c=el('#'+canvasId); let url='';
            try{ const map={statusChart,typeChart,trendChart,agingChart,topTypeChart}; const ref=map[canvasId]; url = (ref && ref.toBase64Image) ? ref.toBase64Image('image/png',1) : c.toDataURL('image/png'); }
            catch(e){ url=c.toDataURL('image/png'); }
            a.href=url; a.download=name; });
        }
        exportCanvas('#dlStatus','statusChart','status-chart.png');
        exportCanvas('#dlType','typeChart','type-chart.png');
        exportCanvas('#dlTrend','trendChart','trend-chart.png');
        exportCanvas('#dlAging','agingChart','aging-chart.png');
        exportCanvas('#dlTopType','topTypeChart','top-types-chart.png');

        loadDefaults();
        recomputeAndRender();
      }

      ensureChartJs(initDashboard);
    </script>
  </body>
  </html>







